databaseChangeLog:
  - changeSet:
      id: create stub androidx sub-projects
      author: nikita.vlaev@jetbrains.com
      comment: >
        KTL-4037: For each distinct second word of group_id among packages
        belonging to the current "androidx" project, create a new project row
        sharing the same scm_repo and owner. latest_version and latest_version_ts
        are computed from the newest package in each group.
      changes:
        - sql:
            sql: |
              INSERT INTO project (scm_repo_id, owner_id, name, description, minimized_readme, latest_version, latest_version_ts)
              SELECT DISTINCT ON (split_part(pkg.group_id, '.', 2))
                     p.scm_repo_id,
                     p.owner_id,
                     split_part(pkg.group_id, '.', 2),
                     NULL, -- generated by AI
                     NULL, -- generated by AI
                     pkg.version,
                     pkg.release_ts
              FROM package pkg
              JOIN project p ON pkg.project_id = p.id
              JOIN scm_owner o ON p.owner_id = o.id
              WHERE p.name = 'androidx'
                AND o.login = 'androidx'
              ORDER BY split_part(pkg.group_id, '.', 2), pkg.release_ts DESC
              -- This makes migration idempotent
              ON CONFLICT (scm_repo_id, name) DO UPDATE
                SET latest_version    = EXCLUDED.latest_version,
                    latest_version_ts = EXCLUDED.latest_version_ts;

  - changeSet:
      id: relink androidx packages to new sub-projects
      author: nikita.vlaev@jetbrains.com
      comment: >
        KTL-4037: Update package.project_id for all packages currently linked
        to the old "androidx" project to point to the matching new sub-project.
      changes:
        - sql:
            sql: |
              UPDATE package
              SET project_id = new_project.id
              FROM project old_project
              JOIN scm_owner o ON old_project.owner_id = o.id,
                   project new_project
              WHERE old_project.name = 'androidx'
                AND o.login = 'androidx'
                AND package.project_id = old_project.id
                AND new_project.scm_repo_id = old_project.scm_repo_id
                AND new_project.name = split_part(package.group_id, '.', 2);
