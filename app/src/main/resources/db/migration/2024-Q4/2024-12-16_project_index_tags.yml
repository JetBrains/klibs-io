databaseChangeLog:
    - changeSet:
        id: recreate project_index materialized view
        author: nikita.vlaev@jetbrains.com
        preConditions:
            - onFail: HALT
            - and:
              - sqlCheck:
                  expectedResult: 1
                  sql: |
                    SELECT COUNT(*) 
                    FROM pg_matviews
                    WHERE schemaname = current_schema()
                      AND matviewname = 'project_index'
              - tableExists:
                  tableName: project_tags
        changes:
            - sqlFile:
                path: 2024-12-16_project_index_tags.sql
                relativeToChangelogFile: true

    - changeSet:
          id: add project_index_fts_gin_idx to project_index
          author: nikita.vlaev@jetbrains.com
          preConditions:
              - onFail: MARK_RAN
              - not:
                    indexExists:
                        tableName: project_index
                        indexName: project_index_fts_gin_idx
          changes:
              - sql:
                    sql: |
                        CREATE INDEX project_index_fts_gin_idx ON project_index USING GIN (fts);

    - changeSet:
          id: add project_index_platforms_vector_gin_idx to project_index
          author: nikita.vlaev@jetbrains.com
          preConditions:
              - onFail: MARK_RAN
              - not:
                    indexExists:
                        tableName: project_index
                        indexName: project_index_platforms_vector_gin_idx
          changes:
              - sql:
                    sql: |
                        CREATE INDEX project_index_platforms_vector_gin_idx ON project_index USING GIN (platforms_vector);

    - changeSet:
          id: add project_index_stars_idx to project_index
          author: nikita.vlaev@jetbrains.com
          preConditions:
              - onFail: MARK_RAN
              - not:
                    indexExists:
                        tableName: project_index
                        indexName: project_index_stars_idx
          changes:
              - createIndex:
                    tableName: project_index
                    indexName: project_index_stars_idx
                    columns:
                        - column:
                              name: stars

    - changeSet:
          id: add project_index_project_id_idx to
          author: nikita.vlaev@jetbrains.com
          preConditions:
              - onFail: MARK_RAN
              - not:
                  indexExists:
                      tableName: project_index
                      indexName: project_index_project_id_idx
          changes:
              - createIndex:
                    tableName: project_index
                    indexName: project_index_project_id_idx
                    columns:
                        - column:
                              name: project_id